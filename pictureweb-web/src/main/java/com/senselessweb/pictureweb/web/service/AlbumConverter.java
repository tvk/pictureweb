package com.senselessweb.pictureweb.web.service;

import java.util.Collection;
import java.util.Set;
import java.util.function.Function;
import java.util.function.Supplier;
import java.util.stream.Collectors;

import org.apache.commons.lang3.StringUtils;
import org.springframework.stereotype.Service;

import com.google.common.collect.Sets;
import com.senselessweb.pictureweb.commons.storage.StoredPhotos;
import com.senselessweb.pictureweb.datastore.client.PhotoService;
import com.senselessweb.pictureweb.datastore.domain.Album;
import com.senselessweb.pictureweb.datastore.domain.Photo;
import com.senselessweb.pictureweb.web.domain.ClientAlbum;
import com.senselessweb.pictureweb.web.domain.ClientGeoData;
import com.senselessweb.pictureweb.web.domain.ClientPhoto;

@Service
public class AlbumConverter implements Function<Album, ClientAlbum> {
  
  private static final Set<String> hiddenPictures = Sets.newHashSet(
      "27216894106", "26645517503", "27216184746", "26644592983", "26643338064", "27216640296", "27250678725", "26645238493",
      "26757902023", "27155670422", "27218929756", "27183274531", "26977384480", "27183339641", "27297721181",
      "27217939366", "27182319741", "26645223934", "26645648844", "27218706206",
      "27272953225", "27203014851", "26666017604", "27273337655", "27304683456", "27304898556", "27338252745", "27241048662",
      "26639938794", "26971795450", "27247278495", "26641635583", "27177920791", "26640250354", "26640992514", "26643127203", "27289185281", "27248709365", "27084315150", "27326258516",
      "27063413940", "27286628891", "27082063720", "27259732502", "27059695840", "26730938304",
      "27327248806", "27290152391", "26754619133", "27327785006", "27085830150", "26754044164", "26754901803", "27291057301",
      "23832128055", "23749603241", "23805973166", "23536406500",
      "26759504423", "27268467612", "26758758794", "27366359045", "27332990666", "27091083560", "27367388535", "27367858125",
      "27293733321", "26756892904", "27471304950", "27648999172", "27675064031",
      "23420859510", "23088578004", "23690486506", "23608221862", "23634207691", "23421112970", "23088620174", "23716743645", "23828874075", "23691076236", "23634798451", "23608731742", "23349270469", "23350887959", "23351851819", "23091634154", "23534235060", "23721258202", "23533885800", "23533870840", "23721897602", "23535476180", "23204519473", "23748824801",
      "24892864094", "25155888769", "24892963344", "25155930349", "24896822503", "25497716636", "25431046901", "25497788276", "25497932236", "25405508042", "25497965256", "25498036716", "25431383181", "24893587874", "25431349921", "25156709049", "25156680399", "25405684812", "24897477313", "25405755402", "24897741953", "25498278366", "25498424016", "25168080439", "24909365483", "25168198799", "25417389292", "25509961896", "25510056316", "25168486859",
      "27718338776", "27677983741", "27474334060", "27140280584", "27678283781", "27680661671", "27144341693", "27755306565", "27143358914", "27721315006", "27144673723", "27755565915",
      "27643891842", "27132011294", "27135100874", "27135124164", "27713622676", "27647118372", "27469749990", "27135341734", "27647233392", "27747818405",
      "28798137495", "28720971651", "28514134080", "28183709053", "28693465402",
      "27673258031", "27648131502", "27748755945", "27649485632", "27649833552", "27716325346", "27650010272", "27472582820", "27750722365", "27750737035", "27716605376", "27650138232", "27676251221", "27676324671", "27472720130", "27138613784", "27472761680", "27676473861", "27676539181", "27751595595",
      "27139329534", "27651263792", "27751795785", "27140042684", "27652300982", "27718670366", "27718711086", "27721368736", "27477119610", "27477105580", "27143522284", "27721968106", "27681954231", "27756563485", "27144357164", "27144918824", "27656370162", "27144918824", "27656467262", "27478617930", "27656555232", "27478850220", "27486035360", "27690077451",
      "14405933443", "14384353772", "14385839925", "14199328020", "14199558117", "14382672891", "14384628892", "14382682511", "14199418988", "14406217943", "14406237813", "14384668142", "14362993556", "14385269454", "14363182846", "14363220746", "14199769800", "14363223956", "14363230776", "14199779250", "14406499373", "14199812068", "14199893299", "14200113517", "14386572815", "14200307857", "14200149688", "14385839974", "14383492711", "14383510531", "14385871764", "14407037143", "14200304350", "14385866724", "14383526741", "14384184691", "14364496336", "14200954309", "14200956029", "14386410042", "14386836564", "14201215909", "14387876765", "14201285468",
      "27857340936", "27614209400", "27857471306", "27370837294", "27949393236",
      "14399636446", "14236120959", "14236166748", "14236175450", "14236132499", "14442990583", "14422811135", "14236230190", "14443018453", "14419493381", "14422848805", "14236398257", "14399738766", "14236260928", "14399741036", "14421592662", "14236289740", "14443064553", "14236300798", "14421713472", "14399935526", "14236556500",
      "15722664749", "15723015499",
      "15269694308", "15269654519", "15433536206", "15270122538", "15270139060", "15456941262", "15457373425", "15434346646", "15454256521", "15457170642", "15270848748", "15457144622", "15270893108", "15454320701", "15270908638", "15270735329", "15454383341", "15457251982", "15270964388", "15270882729", "15457281482", "15271255167", "15271265848", "15271282097", "15434799336", "15271379959", "15458143635", "15455081481", "15271464610", "15435154036", "15455058621", "15271559379", "15458375315", "15271644419", "15271674269", "15455628825", "15271831708",
      "14236249099", "14238283458", "14236100039", "14237987638", "14236156170", "14421290101", "14424661075", "14422751535", "14422752815", "14236162350", "14421324331", "14236160250", "14421467242", "14238096920", "14444895513", "14238058359", "14421381731", "14421638844", "14424766235", "14444956413",
      "14237119867", "14236927748", "14237159007", "14420263421", "14237455397", "14422710212", "14237451668", "14424071945", "14237635117", "14237626997", "14400987746", "14422958674",
      "14423080684", "14237739657", "14237638610");

  private final PhotoConverter photoConverter;
  private final PhotoService photoService;
  private final StoredPhotos storedPhotos;

  public AlbumConverter(final PhotoConverter photoConverter, final PhotoService photoService,
      final StoredPhotos storedPhotos) {
    this.photoConverter = photoConverter;
    this.photoService = photoService;
    this.storedPhotos = storedPhotos;
  }

  @Override
  public ClientAlbum apply(final Album album) {
    return new ClientAlbum(album.getId(), album.getTitle(), album.getDescription(), 
        convertPicture(album.getPrimaryPhotoId()), 
        findGeoData(album), convertPictures(album));
  }

  private Supplier<Collection<ClientPhoto>> convertPictures(Album album) {
    return new Supplier<Collection<ClientPhoto>>() {
      @Override
      public Collection<ClientPhoto> get() {
        return album.getPhotos().stream()
            .filter(p -> !hiddenPictures.contains(p))
            .filter(p -> storedPhotos.isComplete(p))
            .map(p -> convertPicture(p))
            .collect(Collectors.toList());
      }
    };
    
  }

  private ClientGeoData findGeoData(final Album album) {
    if (album.getPrimaryPhotoId() != null) {
      final Photo primaryPhoto = photoService.get(album.getPrimaryPhotoId());
      if (primaryPhoto != null && primaryPhoto.getGeo() != null) {
        return new ClientGeoData(primaryPhoto.getGeo());
      }
    }

    return null;
  }

  private ClientPhoto convertPicture(final String photoId) {
    return StringUtils.isBlank(photoId) ? null : photoConverter.apply(photoService.get(photoId));
  }
}
